<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Familiar Multijugador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://css.gg/css?=|copy|check-o|close-o" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
            background-color: #fdfdfa;
            color: #3a3a3a;
            font-size: 1.1rem; 
        }
        .handwriting {
             font-family: 'Caveat', cursive;
        }
        .screen {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .screen.active {
            display: flex;
            opacity: 1;
        }
        .btn {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        .option-btn {
            border: 2px solid #ccc;
            background-color: #ffffff;
        }
        .option-btn:hover:not(:disabled) {
           background-color: #f0f0f0;
        }
        .option-btn.selected {
            border-color: #f59e0b;
            transform: scale(1.05);
            background-color: #fffbeb;
        }
        .option-btn.correct {
            background-color: #22c55e !important;
            color: white !important;
            border-color: #16a34a;
        }
        .option-btn.incorrect {
            background-color: #ef4444 !important;
            color: white !important;
            border-color: #dc2626;
            opacity: 0.7;
        }
        .timer-bar {
            transition: width 1s linear;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            padding: 2rem;
        }
        /* Topic colors */
        .topic-ciencia { color: #2563eb; } /* Blue */
        .topic-tecnologia { color: #4f46e5; } /* Indigo */
        .topic-cultura-general { color: #db2777; } /* Pink */
        .topic-arte-y-literatura { color: #ca8a04; } /* Amber */
        .topic-logica-y-matematicas { color: #16a34a; } /* Green */
        .topic-votacion { color: #9333ea; } /* Purple */
        
        /* Custom Toast Notification */
        #toast {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            background-color: #ef4444;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: top 0.5s ease-in-out;
            z-index: 1000;
            font-size: 1.2rem;
        }
        #toast.show {
            top: 20px;
        }
    </style>
</head>
<body class="w-screen h-screen flex items-center justify-center p-4">

    <!-- Toast Notification -->
    <div id="toast"></div>

    <!-- Pantalla de Inicio / Lobby -->
    <div id="lobby-screen" class="screen active w-full max-w-lg mx-auto flex-col items-center justify-center text-center">
        <div class="card w-full">
            <h1 class="text-6xl font-bold mb-4 handwriting">Quiz Familiar</h1>
            <p class="mb-8 text-2xl text-gray-600 handwriting">¡Demuestra quién sabe más!</p>
            <div id="initial-options" class="w-full">
                <input id="player-name-input" type="text" placeholder="Escribe tu nombre" class="w-full px-4 py-3 mb-4 rounded-lg text-gray-800 text-center text-lg border-2 border-gray-300 focus:border-indigo-500 focus:ring-indigo-500">
                <button id="create-game-btn" class="btn w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg text-2xl mb-3">Crear Partida</button>
                <button id="join-game-btn" class="btn w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-2xl">Unirse a Partida</button>
            </div>
            <div id="join-options" class="w-full hidden">
                <input id="game-id-input" type="text" placeholder="Código de la partida" class="w-full px-4 py-3 mb-4 rounded-lg text-gray-800 text-center text-lg border-2 border-gray-300 focus:border-green-500 focus:ring-green-500" maxlength="5">
                <button id="confirm-join-btn" class="btn w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-2xl">Confirmar y Unirse</button>
                 <button id="back-to-lobby-btn" class="btn w-full bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg text-xl mt-4">Volver</button>
            </div>
            <div id="waiting-room" class="w-full hidden mt-8">
                <h2 class="text-3xl font-semibold handwriting">Sala de Espera</h2>
                <p class="text-gray-600 text-xl">Comparte este código con otros jugadores:</p>
                <div id="game-id-display" class="my-4 p-3 bg-gray-100 rounded-lg text-4xl font-bold tracking-widest cursor-pointer text-gray-800 flex items-center justify-center gap-2" title="Copiar código">...</div>
                <h3 class="text-2xl mt-6 mb-2 handwriting">Jugadores Conectados:</h3>
                <ul id="player-list" class="text-left bg-gray-50 p-4 rounded-lg text-xl space-y-2"></ul>
                <button id="start-game-btn" class="btn w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-4 rounded-lg text-2xl mt-6 hidden">¡Empezar a Jugar!</button>
            </div>
        </div>
    </div>

    <!-- Pantalla Intermedia -->
    <div id="interstitial-screen" class="screen w-full max-w-3xl mx-auto flex-col items-center justify-center text-center">
        <div class="card w-full fade-in">
             <h2 class="text-5xl text-gray-600 handwriting">Pregunta <span id="interstitial-difficulty"></span></h2>
             <h1 id="interstitial-topic" class="text-8xl font-bold mt-4 break-words handwriting"></h1>
        </div>
    </div>

    <!-- Pantalla del Quiz -->
    <div id="quiz-screen" class="screen w-full max-w-4xl mx-auto flex-col items-center">
        <div class="card w-full">
            <div class="w-full flex justify-between items-center mb-4">
                <div class="text-3xl font-bold">Pregunta <span id="question-number">1</span>/<span id="question-total">15</span></div>
                <div class="text-3xl font-bold flex items-center">
                    <span id="timer">20</span>s
                </div>
            </div>
            <div class="w-full bg-gray-200 rounded-lg mb-4 h-3">
                <div id="timer-bar" class="timer-bar h-3 bg-amber-400 rounded-lg" style="width: 100%;"></div>
            </div>
            <h2 id="question-text" class="text-3xl font-bold text-center mb-6 p-2 min-h-[100px]">Cargando pregunta...</h2>
            <div id="options-container" class="w-full grid grid-cols-1 md:grid-cols-2 gap-4">
            </div>
            <div id="waiting-for-players" class="mt-8 text-2xl text-gray-500 hidden text-center">¡Respuesta enviada! Esperando a los demás...</div>
        </div>
    </div>

    <!-- Pantalla de Resultados de Ronda -->
    <div id="round-results-screen" class="screen w-full max-w-3xl mx-auto flex-col items-center text-center">
        <div class="card w-full">
            <h2 id="result-title" class="text-5xl font-bold mb-4 handwriting">¡Tiempo!</h2>
            <div id="answer-reveal" class="text-2xl mb-6">La respuesta correcta era: <strong id="correct-answer-text" class="text-green-600 font-bold"></strong></div>
            <div id="vote-reveal" class="w-full text-left text-xl hidden mb-6 bg-gray-100 p-4 rounded-lg">
                <h4 class="font-bold text-center mb-2">Así habéis votado:</h4>
                <ul id="vote-details-list"></ul>
            </div>
            <div class="w-full bg-gray-50 p-4 rounded-lg">
                <h3 class="text-3xl font-semibold mb-4 handwriting">Resultados de la Ronda</h3>
                <div id="round-player-results" class="space-y-3">
                </div>
            </div>
            <button id="next-question-btn" class="btn w-full max-w-xs bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg text-2xl mt-8 hidden">¡Listo!</button>
            <button id="show-final-results-btn" class="btn w-full max-w-xs bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-4 rounded-lg text-2xl mt-8 hidden">Ver Resultados Finales</button>
        </div>
    </div>

    <!-- Pantalla Final -->
    <div id="game-over-screen" class="screen w-full max-w-3xl mx-auto flex-col items-center text-center">
        <div class="card w-full">
            <h2 class="text-6xl font-bold mb-4 handwriting">¡Fin del Juego!</h2>
            <div id="winner-announcement" class="text-4xl mb-8"></div>
            <div class="w-full bg-gray-50 p-6 rounded-lg">
                <h3 class="text-4xl font-semibold mb-4 handwriting">Puntuación Final</h3>
                <div id="final-scores" class="space-y-3">
                </div>
            </div>
            <button id="play-again-btn" class="btn w-full max-w-xs bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-2xl mt-8">Jugar Otra Vez</button>
        </div>
    </div>


    <script type="module">
        // Import Realtime Database functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, onValue, set, update, get, serverTimestamp, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // --- Firebase Configuration ---
        const firebaseConfig = { databaseURL: "https://webmc-46fab-default-rtdb.europe-west1.firebasedatabase.app/" };
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // --- Global State ---
        let localPlayerId = sessionStorage.getItem('quizPlayerId') || `player_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
        sessionStorage.setItem('quizPlayerId', localPlayerId);
        
        let currentGameId = null;
        let gameRef = null;
        let gameData = null; // Local copy of game state
        let timerInterval = null;
        let isMovingToNext = false;

        // --- UI Elements ---
        const screens = { lobby: document.getElementById('lobby-screen'), interstitial: document.getElementById('interstitial-screen'), quiz: document.getElementById('quiz-screen'), roundResults: document.getElementById('round-results-screen'), gameOver: document.getElementById('game-over-screen') };
        const playerNameInput = document.getElementById('player-name-input');
        const createGameBtn = document.getElementById('create-game-btn');
        const joinGameBtn = document.getElementById('join-game-btn');
        const gameIdInput = document.getElementById('game-id-input');
        const confirmJoinBtn = document.getElementById('confirm-join-btn');
        const initialOptions = document.getElementById('initial-options');
        const joinOptions = document.getElementById('join-options');
        const waitingRoom = document.getElementById('waiting-room');
        const gameIdDisplay = document.getElementById('game-id-display');
        const playerList = document.getElementById('player-list');
        const startGameBtn = document.getElementById('start-game-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const showFinalResultsBtn = document.getElementById('show-final-results-btn');
        const playAgainBtn = document.getElementById('play-again-btn');
        const backToLobbyBtn = document.getElementById('back-to-lobby-btn');
        const toastEl = document.getElementById('toast');
        const voteRevealEl = document.getElementById('vote-reveal');
        const answerRevealEl = document.getElementById('answer-reveal');
        
        // --- Utility Functions ---
        const showAlert = (message) => {
            console.warn("ALERT:", message);
            toastEl.innerText = message;
            toastEl.classList.add('show');
            setTimeout(() => { toastEl.classList.remove('show'); }, 3000);
        };

        const switchScreen = (screenName) => {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            if (screens[screenName]) screens[screenName].classList.add('active');
        };
        
        const fetchQuestions = async () => {
             const votingQuestions = [
                { "type": "voting", "question": "¿Quién duraría más en una isla desierta?", "topic": "Votacion" },
                { "type": "voting", "question": "¿Quién tiene más probabilidades de convertirse en millonario?", "topic": "Votacion" },
                { "type": "voting", "question": "¿Quién es el más propenso a tropezar con su propia sombra?", "topic": "Votacion" },
                { "type": "voting", "question": "¿Quién daría el discurso más raro en una boda?", "topic": "Votacion" },
                { "type": "voting", "question": "Si formaran una banda, ¿quién sería el cantante principal?", "topic": "Votacion" },
                { "type": "voting", "question": "¿Quién sobreviviría a un apocalipsis zombie?", "topic": "Votacion" },
                { "type": "voting", "question": "¿Quién es más probable que se ría en un momento serio?", "topic": "Votacion" },
                { "type": "voting", "question": "¿Quién es el mejor para guardar un secreto?", "topic": "Votacion" },
                { "type": "voting", "question": "¿Quién tiene el sentido del humor más extraño?", "topic": "Votacion" },
                { "type": "voting", "question": "¿Quién se perdería con un mapa en la mano?", "topic": "Votacion" },
                { "type": "voting", "question": "¿Quién es más probable que hable con los animales?", "topic": "Votacion" },
                { "type": "voting", "question": "¿Quién ganaría un concurso de comer perritos calientes?", "topic": "Votacion" },
                { "type": "voting", "question": "¿Quién es más probable que se una a un circo?", "topic": "Votacion" },
                { "type": "voting", "question": "¿Quién es el más dramático del grupo?", "topic": "Votacion" },
                { "type": "voting", "question": "¿Quién ordenaría pizza de piña sin remordimientos?", "topic": "Votacion" }
            ];

            const url = 'https://raw.githubusercontent.com/Logise1123/familyquiz/main/questions.json';
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const triviaQuestions = await response.json();
                
                // Shuffle both arrays
                const shuffledTrivia = triviaQuestions.sort(() => 0.5 - Math.random());
                const shuffledVoting = votingQuestions.sort(() => 0.5 - Math.random());
                
                // Take 11 trivia and 4 voting questions
                const finalQuestions = shuffledTrivia.slice(0, 11).concat(shuffledVoting.slice(0, 4));
                
                // Shuffle the final mix
                return finalQuestions.sort(() => 0.5 - Math.random());

            } catch (error)
            {
                console.error("No se pudieron cargar las preguntas desde GitHub:", error);
                showAlert("Error al cargar preguntas. Se usarán preguntas de respaldo.");
                const trivia = [{ question: "¿Cuál es la capital de España?", options: ["Barcelona", "Lisboa", "Madrid", "París"], answer: "Madrid", difficulty: "Fácil", topic: "Cultura General" }];
                return trivia.concat(votingQuestions.slice(0,4));
            }
        };

        // --- Game Logic ---
        const createGame = async () => {
            if (!playerNameInput.value.trim()) { showAlert("Por favor, introduce tu nombre."); return; }
            createGameBtn.disabled = true; joinGameBtn.disabled = true; createGameBtn.innerText = "Cargando...";

            try {
                const gameQuestions = await fetchQuestions();
                if (!gameQuestions || gameQuestions.length === 0) throw new Error("Failed to fetch questions.");
                
                currentGameId = Math.random().toString(36).substr(2, 5).toUpperCase();
                gameRef = ref(database, `games/${currentGameId}`);
                
                await set(gameRef, {
                    hostId: localPlayerId,
                    gameState: 'lobby',
                    currentQuestionIndex: -1,
                    questions: gameQuestions,
                    players: { [localPlayerId]: { name: playerNameInput.value.trim(), score: 0 } }
                });
                
                const playerRef = ref(database, `games/${currentGameId}/players/${localPlayerId}`);
                onDisconnect(playerRef).remove();
                subscribeToGameChanges();
            } catch (error) {
                console.error("Error al crear la partida:", error);
                showAlert("Hubo un problema al crear la partida.");
                createGameBtn.disabled = false; joinGameBtn.disabled = false; createGameBtn.innerText = "Crear Partida";
            }
        };

        const joinGame = async () => {
            if (!playerNameInput.value.trim()) { showAlert("Por favor, introduce tu nombre."); return; }
            confirmJoinBtn.disabled = true; confirmJoinBtn.innerText = "Uniéndose...";
            
            const gameIdToJoin = gameIdInput.value.trim().toUpperCase();
            if (!gameIdToJoin) {
                showAlert("Por favor, introduce un código de partida.");
                confirmJoinBtn.disabled = false; confirmJoinBtn.innerText = "Confirmar y Unirse";
                return;
            }
            
            try {
                const joinRef = ref(database, `games/${gameIdToJoin}`);
                const snapshot = await get(joinRef);
                if (!snapshot.exists()) {
                    showAlert("Partida no encontrada.");
                    throw new Error("Game not found");
                }
                
                const gameDataTemp = snapshot.val();
                if (gameDataTemp.gameState !== 'lobby') {
                    showAlert("Esta partida ya ha comenzado.");
                    throw new Error("Game already started");
                }

                currentGameId = gameIdToJoin;
                gameRef = joinRef;
                
                const newPlayerData = { name: playerNameInput.value.trim(), score: 0 };
                const updates = {};
                updates[`/players/${localPlayerId}`] = newPlayerData;
                await update(gameRef, updates);

                const playerRef = ref(database, `games/${currentGameId}/players/${localPlayerId}`);
                onDisconnect(playerRef).remove();
                subscribeToGameChanges();
            } catch(error) {
                console.error("Error al unirse a la partida:", error);
                confirmJoinBtn.disabled = false; confirmJoinBtn.innerText = "Confirmar y Unirse";
            }
        };
        
        const subscribeToGameChanges = () => {
            if (!gameRef) return;
            onValue(gameRef, (snapshot) => {
                gameData = snapshot.val();
                if (gameData) {
                    renderGame();
                } else {
                    showAlert("La partida ha terminado o ya no existe.");
                    resetGame();
                }
            });
        };

        const renderGame = () => {
            if (!gameData || !gameData.players) return;
            if (!gameData.players[localPlayerId] && gameData.gameState !== 'lobby') {
                showAlert("Has sido desconectado de la partida.");
                resetGame();
                return;
            }

            switch (gameData.gameState) {
                case 'lobby': renderLobby(); break;
                case 'interstitial': renderInterstitial(); break;
                case 'question': renderQuestionScreen(); break;
                case 'roundResult': renderRoundResult(); break;
                case 'gameOver': renderGameOver(); break;
            }
        };
        
        const renderLobby = () => {
            switchScreen('lobby');
            initialOptions.classList.add('hidden');
            joinOptions.classList.add('hidden');
            waitingRoom.classList.remove('hidden');
            gameIdDisplay.innerHTML = `${currentGameId} <i class="gg-copy text-gray-500"></i>`;
            
            playerList.innerHTML = Object.entries(gameData.players).map(([id, p]) => `
                <li class="p-1 flex items-center gap-2">
                    <span class="text-2xl">${gameData.hostId === id ? '👑' : '👤'}</span> 
                    ${p.name}
                </li>`).join('');
            
            if (gameData.hostId === localPlayerId) startGameBtn.classList.remove('hidden');
        };

        const renderInterstitial = () => {
            switchScreen('interstitial');
            const question = gameData.questions[gameData.currentQuestionIndex];
            if (!question) return;

            document.getElementById('interstitial-difficulty').innerText = question.difficulty || '';
            const topicEl = document.getElementById('interstitial-topic');
            topicEl.innerText = question.topic;

            topicEl.className = 'text-8xl font-bold mt-4 break-words handwriting'; 
            const topicClass = 'topic-' + question.topic.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '-');
            topicEl.classList.add(topicClass);

            if (gameData.hostId === localPlayerId) {
                setTimeout(() => {
                    update(gameRef, { 
                        gameState: 'question', 
                        questionStartTime: serverTimestamp() 
                    });
                }, 4000); 
            }
        };
        
        const renderQuestionScreen = () => {
            const question = gameData.questions[gameData.currentQuestionIndex];
            if (question.type === 'voting') {
                renderVotingQuestion(question);
            } else {
                renderTriviaQuestion(question);
            }
        }

        const renderTriviaQuestion = (question) => {
            setupQuestionUI(question);
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            question.options.forEach(option => {
                const button = document.createElement('button');
                button.className = "option-btn btn w-full text-gray-800 font-semibold py-3 px-4 rounded-lg text-xl md:text-2xl";
                button.innerText = option;
                button.onclick = () => selectAnswer(option);
                optionsContainer.appendChild(button);
            });
            // Re-check answered status
            if (gameData.players[localPlayerId]?.currentAnswer) {
                document.querySelectorAll('.option-btn').forEach(btn => {
                    btn.disabled = true;
                    if(btn.innerText === gameData.players[localPlayerId].currentAnswer) btn.classList.add('selected');
                });
                document.getElementById('waiting-for-players').classList.remove('hidden');
            }
        };

        const renderVotingQuestion = (question) => {
            setupQuestionUI(question);
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            Object.entries(gameData.players).forEach(([playerId, player]) => {
                const button = document.createElement('button');
                button.className = "option-btn btn w-full text-gray-800 font-semibold py-3 px-4 rounded-lg text-xl md:text-2xl";
                button.innerText = player.name;
                button.onclick = () => selectVote(playerId);
                optionsContainer.appendChild(button);
            });
            // Re-check voted status
            if (gameData.players[localPlayerId]?.currentVote) {
                document.querySelectorAll('.option-btn').forEach(btn => {
                    btn.disabled = true;
                    if(btn.innerText === gameData.players[gameData.players[localPlayerId].currentVote].name) btn.classList.add('selected');
                });
                document.getElementById('waiting-for-players').classList.remove('hidden');
            }
        };

        const setupQuestionUI = (question) => {
            switchScreen('quiz');
            clearInterval(timerInterval);
            document.getElementById('waiting-for-players').classList.add('hidden');
            
            const index = gameData.currentQuestionIndex;
            document.getElementById('question-number').innerText = index + 1;
            document.getElementById('question-total').innerText = gameData.questions.length;
            document.getElementById('question-text').innerText = question.question;

            const startTime = gameData.questionStartTime;
            const timerBar = document.getElementById('timer-bar'), timerDisplay = document.getElementById('timer');
            
            timerInterval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;
                const remaining = Math.max(0, 20 - elapsed);
                timerBar.style.width = `${(remaining / 20) * 100}%`;
                timerDisplay.innerText = Math.ceil(remaining);

                const allAnswered = Object.values(gameData.players).every(p => p.currentAnswer || p.currentVote);

                if ((remaining <= 0 || allAnswered) && gameData.hostId === localPlayerId) {
                    clearInterval(timerInterval);
                    showRoundResults();
                }
            }, 100);
        }

        const renderRoundResult = () => {
            switchScreen('roundResults');
            clearInterval(timerInterval);
            isMovingToNext = false;
            
            const question = gameData.questions[gameData.currentQuestionIndex];

            if (question.type === 'voting') {
                answerRevealEl.classList.add('hidden');
                voteRevealEl.classList.remove('hidden');
                document.getElementById('result-title').innerText = "Resultados de la Votación";
                
                const voteDetailsList = document.getElementById('vote-details-list');
                voteDetailsList.innerHTML = '';
                Object.entries(gameData.players).forEach(([voterId, voterData]) => {
                    const votedPlayerId = voterData.currentVote;
                    if (votedPlayerId && gameData.players[votedPlayerId]) {
                        const votedPlayerName = gameData.players[votedPlayerId].name;
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${voterData.name}</strong> votó por <strong>${votedPlayerName}</strong>`;
                        voteDetailsList.appendChild(li);
                    }
                });
            } else {
                answerRevealEl.classList.remove('hidden');
                voteRevealEl.classList.add('hidden');
                document.getElementById('result-title').innerText = "Resultados de la Ronda";
                document.getElementById('correct-answer-text').innerText = question.answer;
            }

            const resultsContainer = document.getElementById('round-player-results');
            resultsContainer.innerHTML = '';
            
            Object.values(gameData.players).sort((a,b) => b.score - a.score).forEach(player => {
                const playerResultDiv = document.createElement('div');
                playerResultDiv.className = 'flex justify-between items-center bg-white p-3 rounded-lg fade-in text-xl';
                const answerIcon = player.currentAnswer ? (player.currentAnswer === question.answer ? '✅' : '❌') : (question.type === 'voting' ? '🗳️' : '🤔');
                const pointsGained = player.lastRoundPoints > 0 ? `+${player.lastRoundPoints}` : '';
                const readyCheck = player.readyForNext ? '<i class="gg-check-o text-green-500"></i>' : '';

                playerResultDiv.innerHTML = `
                    <div class="flex items-center gap-3"><span class="w-6">${readyCheck}</span>${answerIcon} ${player.name}</div>
                    <div class="text-right"><span class="font-bold">${player.score} pts</span><span class="text-sm text-green-600 ml-2 font-bold">${pointsGained}</span></div>`;
                resultsContainer.appendChild(playerResultDiv);
            });

            const isLastQuestion = gameData.currentQuestionIndex >= gameData.questions.length - 1;
            const localPlayer = gameData.players[localPlayerId];
            const primaryBtn = isLastQuestion ? showFinalResultsBtn : nextQuestionBtn;
            primaryBtn.classList.remove('hidden');
            (isLastQuestion ? nextQuestionBtn : showFinalResultsBtn).classList.add('hidden');
            primaryBtn.disabled = !!localPlayer?.readyForNext;
            primaryBtn.innerText = localPlayer?.readyForNext ? "Esperando..." : (isLastQuestion ? "Ver Resultados Finales" : "¡Listo!");

            const allPlayersReady = Object.values(gameData.players).every(p => p.readyForNext);
            if (allPlayersReady && gameData.hostId === localPlayerId) {
                 isLastQuestion ? handleShowFinalResults() : moveToNextQuestionWithDelay();
            }
        };

        const renderGameOver = () => {
            switchScreen('gameOver');
            const players = Object.values(gameData.players).sort((a, b) => b.score - a.score);
            document.getElementById('winner-announcement').innerHTML = `🏆 ¡El ganador es <strong class="text-amber-500">${players[0].name}</strong>! 🏆`;
            const finalScoresContainer = document.getElementById('final-scores');
            finalScoresContainer.innerHTML = '';
            
            players.forEach((player, index) => {
                const rankIcon = ['🥇', '🥈', '🥉'][index] || `#${index+1}`;
                finalScoresContainer.innerHTML += `
                    <div class="flex justify-between items-center bg-white p-3 rounded-lg fade-in text-xl">
                        <div>${rankIcon} ${player.name}</div>
                        <div class="font-bold">${player.score} pts</div>
                    </div>`;
            });
        };
        
        const handleStartGame = () => {
            if (gameData.hostId !== localPlayerId) return;
            update(gameRef, { gameState: 'interstitial', currentQuestionIndex: 0 });
        };
        
        const selectAnswer = (answer) => {
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.disabled = true;
                if(btn.innerText === answer) btn.classList.add('selected');
            });
            document.getElementById('waiting-for-players').classList.remove('hidden');
            const elapsed = (Date.now() - gameData.questionStartTime) / 1000;
            const remainingTime = Math.max(0, 20 - elapsed);
            update(gameRef, { [`/players/${localPlayerId}/currentAnswer`]: answer, [`/players/${localPlayerId}/answerTime`]: remainingTime });
        };

        const selectVote = (votedPlayerId) => {
             document.querySelectorAll('.option-btn').forEach(btn => {
                btn.disabled = true;
                if(btn.innerText === gameData.players[votedPlayerId].name) btn.classList.add('selected');
            });
            document.getElementById('waiting-for-players').classList.remove('hidden');
            update(gameRef, { [`/players/${localPlayerId}/currentVote`]: votedPlayerId });
        };
        
        const showRoundResults = () => {
            if (!gameData || !gameData.players || gameData.gameState !== 'question') return;
            
            const updates = { gameState: 'roundResult' };
            const question = gameData.questions[gameData.currentQuestionIndex];
            
            if (question.type === 'voting') {
                const voteCounts = {};
                Object.keys(gameData.players).forEach(pId => voteCounts[pId] = 0);
                Object.values(gameData.players).forEach(p => {
                    if (p.currentVote && voteCounts[p.currentVote] !== undefined) {
                        voteCounts[p.currentVote]++;
                    }
                });

                const sortedVotes = Object.entries(voteCounts).sort(([, a], [, b]) => b - a);
                
                if (sortedVotes.length > 0) {
                    const firstPlaceVotes = sortedVotes[0][1];
                    const winners = sortedVotes.filter(([, votes]) => votes === firstPlaceVotes && firstPlaceVotes > 0);

                    winners.forEach(([playerId]) => {
                        updates[`/players/${playerId}/lastRoundPoints`] = 100;
                        updates[`/players/${playerId}/score`] = gameData.players[playerId].score + 100;
                    });
                    
                    if (winners.length === 1 && sortedVotes.length > 1) {
                        const secondPlaceVotes = sortedVotes[1][1];
                         const secondPlaceWinners = sortedVotes.filter(([, votes]) => votes === secondPlaceVotes && secondPlaceVotes > 0);
                         secondPlaceWinners.forEach(([playerId]) => {
                            updates[`/players/${playerId}/lastRoundPoints`] = 50;
                            updates[`/players/${playerId}/score`] = gameData.players[playerId].score + 50;
                        });
                    }
                }

                Object.keys(gameData.players).forEach(playerId => {
                    if (updates[`/players/${playerId}/lastRoundPoints`] === undefined) {
                         updates[`/players/${playerId}/lastRoundPoints`] = 0;
                    }
                    updates[`/players/${playerId}/readyForNext`] = false;
                });

            } else { // Trivia question
                const correctAnswer = question.answer;
                Object.keys(gameData.players).forEach(playerId => {
                    const player = gameData.players[playerId];
                    const points = (player.currentAnswer === correctAnswer && player.answerTime) ? (50 + Math.ceil(player.answerTime * 5)) : 0;
                    if (points > 0) updates[`/players/${playerId}/score`] = player.score + points;
                    updates[`/players/${playerId}/lastRoundPoints`] = points;
                    updates[`/players/${playerId}/readyForNext`] = false;
                });
            }
            update(gameRef, updates);
        };
        
        const handlePlayerReady = () => {
            update(gameRef, { [`/players/${localPlayerId}/readyForNext`]: true });
        };
        
        const moveToNextQuestionWithDelay = () => {
            if (isMovingToNext) return;
            isMovingToNext = true;
            
            let countdown = 3;
            document.getElementById('result-title').innerText = `Siguiente en ${countdown}...`;
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    document.getElementById('result-title').innerText = `Siguiente en ${countdown}...`;
                } else {
                    clearInterval(countdownInterval);
                    const nextIndex = gameData.currentQuestionIndex + 1;
                    
                    const updates = { gameState: 'interstitial', currentQuestionIndex: nextIndex };
                    Object.keys(gameData.players).forEach(pId => {
                        updates[`/players/${pId}/currentAnswer`] = null;
                        updates[`/players/${pId}/answerTime`] = null;
                        updates[`/players/${pId}/currentVote`] = null;
                        updates[`/players/${pId}/readyForNext`] = false;
                        updates[`/players/${pId}/lastRoundPoints`] = 0;
                    });
                    update(gameRef, updates);
                }
            }, 1000);
        };

        const handleShowFinalResults = () => { 
            update(gameRef, { gameState: 'gameOver' }); 
        };
        
        const resetGame = () => {
            if (gameData && gameData.hostId === localPlayerId) {
                remove(gameRef);
            }
            sessionStorage.removeItem('quizPlayerId');
            window.location.reload();
        };

        // --- Event Listeners ---
        createGameBtn.addEventListener('click', createGame);
        joinGameBtn.addEventListener('click', () => { initialOptions.classList.add('hidden'); joinOptions.classList.remove('hidden'); });
        confirmJoinBtn.addEventListener('click', joinGame);
        backToLobbyBtn.addEventListener('click', () => { joinOptions.classList.add('hidden'); initialOptions.classList.remove('hidden'); })
        startGameBtn.addEventListener('click', handleStartGame);
        nextQuestionBtn.addEventListener('click', handlePlayerReady);
        showFinalResultsBtn.addEventListener('click', handlePlayerReady);
        playAgainBtn.addEventListener('click', resetGame);
        gameIdDisplay.addEventListener('click', () => {
            if (navigator.clipboard && currentGameId) {
                navigator.clipboard.writeText(currentGameId).then(() => showAlert('¡Código copiado!'));
            }
        });

    </script>
</body>
</html>
