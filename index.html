<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Familiar Multijugador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://css.gg/css?=|copy|check-o|close-o|trash" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
            background-color: #fdfdfa;
            color: #3a3a3a;
            font-size: 1.1rem; 
        }
        .handwriting {
             font-family: 'Caveat', cursive;
        }
        .screen {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .screen.active {
            display: flex;
            opacity: 1;
        }
        .btn {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        .option-btn {
            border: 2px solid #ccc;
            background-color: #ffffff;
        }
        .option-btn:hover:not(:disabled) {
          background-color: #f0f0f0;
        }
        .option-btn.selected {
            border-color: #f59e0b;
            transform: scale(1.05);
            background-color: #fffbeb;
        }
        .timer-bar {
            transition: width 1s linear;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            padding: 2rem;
        }
        /* Topic colors */
        .topic-ciencia, .topic-cultura-general, .topic-arte-y-literatura, .topic-logica-y-matematicas, .topic-tecnologia { color: #db2777; }
        .topic-votacion { color: #9333ea; } /* Purple */
        .topic-dibujo { color: #2563eb; } /* Blue */
        
        #drawing-canvas {
            border: 2px solid #ccc;
            border-radius: 0.5rem;
            touch-action: none;
            background-color: #fff;
        }

        #toast {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            background-color: #ef4444;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: top 0.5s ease-in-out;
            z-index: 1000;
            font-size: 1.2rem;
        }
        #toast.show {
            top: 20px;
        }
        
        label:has(input:checked) {
            border-color: #4f46e5; /* Indigo */
            background-color: #eef2ff; /* Indigo 50 */
        }
        input[type="checkbox"]:checked + span {
            font-weight: 700;
        }
    </style>
</head>
<body class="w-screen h-screen flex items-center justify-center p-4">

    <div id="toast"></div>

    <div id="lobby-screen" class="screen active w-full max-w-lg mx-auto flex-col items-center justify-center text-center">
        <div class="card w-full">
            <h1 class="text-6xl font-bold mb-4 handwriting">Quiz Familiar</h1>
            <p class="mb-8 text-2xl text-gray-600 handwriting">¬°Demuestra qui√©n sabe m√°s!</p>
            <div id="initial-options" class="w-full">
                <input id="player-name-input" type="text" placeholder="Escribe tu nombre" class="w-full px-4 py-3 mb-4 rounded-lg text-gray-800 text-center text-lg border-2 border-gray-300 focus:border-indigo-500 focus:ring-indigo-500">
                <button id="show-create-menu-btn" class="btn w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg text-2xl mb-3">Crear Partida</button>
                <button id="join-game-btn" class="btn w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-2xl">Unirse a Partida</button>
            </div>
            <div id="create-menu" class="w-full hidden">
                 <div id="game-modes" class="my-6 text-left">
                    <h3 class="text-2xl font-semibold mb-3 text-center handwriting">Elige los tipos de pregunta:</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <label for="mode-quiz" class="flex items-center justify-center p-3 border-2 rounded-lg cursor-pointer transition-colors duration-200">
                            <input type="checkbox" id="mode-quiz" class="hidden peer" value="quiz" checked>
                            <span class="text-xl font-semibold peer-checked:text-pink-500">üß† Quiz</span>
                        </label>
                        <label for="mode-voting" class="flex items-center justify-center p-3 border-2 rounded-lg cursor-pointer transition-colors duration-200">
                            <input type="checkbox" id="mode-voting" class="hidden peer" value="voting" checked>
                            <span class="text-xl font-semibold peer-checked:text-purple-500">üó≥Ô∏è Votaci√≥n</span>
                        </label>
                        <label for="mode-drawing" class="flex items-center justify-center p-3 border-2 rounded-lg cursor-pointer transition-colors duration-200">
                            <input type="checkbox" id="mode-drawing" class="hidden peer" value="drawing" checked>
                            <span class="text-xl font-semibold peer-checked:text-blue-500">üé® Dibujo</span>
                        </label>
                    </div>
                </div>
                <button id="create-game-btn" class="btn w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg text-2xl mb-3">Confirmar y Crear</button>
                <button id="back-from-create-btn" class="btn w-full bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg text-xl">Volver</button>
            </div>
            <div id="join-options" class="w-full hidden">
                <input id="game-id-input" type="text" placeholder="C√≥digo de la partida" class="w-full px-4 py-3 mb-4 rounded-lg text-gray-800 text-center text-lg border-2 border-gray-300 focus:border-green-500 focus:ring-green-500" maxlength="5">
                <button id="confirm-join-btn" class="btn w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-2xl">Confirmar y Unirse</button>
                 <button id="back-to-lobby-btn" class="btn w-full bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg text-xl mt-4">Volver</button>
            </div>
            <div id="waiting-room" class="w-full hidden mt-8">
                <h2 class="text-3xl font-semibold handwriting">Sala de Espera</h2>
                <p class="text-gray-600 text-xl">Comparte este c√≥digo con otros jugadores:</p>
                <div id="game-id-display" class="my-4 p-3 bg-gray-100 rounded-lg text-4xl font-bold tracking-widest cursor-pointer text-gray-800 flex items-center justify-center gap-2" title="Copiar c√≥digo">...</div>
                <h3 class="text-2xl mt-6 mb-2 handwriting">Jugadores Conectados:</h3>
                <ul id="player-list" class="text-left bg-gray-50 p-4 rounded-lg text-xl space-y-2"></ul>
                <button id="start-game-btn" class="btn w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-4 rounded-lg text-2xl mt-6 hidden">¬°Empezar a Jugar!</button>
            </div>
        </div>
    </div>

    <div id="interstitial-screen" class="screen w-full max-w-3xl mx-auto flex-col items-center justify-center text-center">
        <div class="card w-full fade-in">
             <h2 class="text-5xl text-gray-600 handwriting">Pregunta <span id="interstitial-difficulty"></span></h2>
             <h1 id="interstitial-topic" class="text-8xl font-bold mt-4 break-words handwriting"></h1>
        </div>
    </div>

    <div id="quiz-screen" class="screen w-full max-w-4xl mx-auto flex-col items-center">
        <div class="card w-full">
            <div class="w-full flex justify-between items-center mb-4">
                <div id="quiz-header-text" class="text-3xl font-bold">Pregunta <span id="question-number">1</span>/<span id="question-total">20</span></div>
                <div class="text-3xl font-bold flex items-center"><span id="timer">20</span>s</div>
            </div>
            <div class="w-full bg-gray-200 rounded-lg mb-4 h-3">
                <div id="timer-bar" class="timer-bar h-3 bg-amber-400 rounded-lg" style="width: 100%;"></div>
            </div>
            <img id="drawing-display-img" class="hidden mx-auto mb-4 border-2 border-gray-400 rounded-lg bg-white" style="max-width: 90%; height: auto; max-height: 300px;">
            <h2 id="question-text" class="text-3xl font-bold text-center mb-6 p-2 min-h-[60px]">Cargando...</h2>
            <div id="options-container" class="w-full grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            <div id="waiting-for-players" class="mt-8 text-2xl text-gray-500 hidden text-center">¬°Listo! Esperando a los dem√°s...</div>
        </div>
    </div>

    <div id="drawing-screen" class="screen w-full max-w-2xl mx-auto flex-col items-center justify-center">
        <div class="card w-full">
             <div class="w-full flex justify-between items-center mb-2">
                <div class="text-3xl font-bold">¬°A dibujar!</div>
                <div class="text-3xl font-bold flex items-center"><span id="drawing-timer">30</span>s</div>
            </div>
            <div class="w-full bg-gray-200 rounded-lg mb-4 h-3">
                <div id="drawing-timer-bar" class="timer-bar h-3 bg-amber-400 rounded-lg" style="width: 100%;"></div>
            </div>
            <div id="drawing-ui">
                <h2 class="text-3xl font-bold text-center mb-4">Tu palabra es: <span id="word-to-draw" class="text-indigo-600"></span></h2>
                <canvas id="drawing-canvas" width="500" height="300"></canvas>
                <div class="flex justify-center gap-4 mt-4">
                    <button id="clear-canvas-btn" class="btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-xl flex items-center gap-2"><i class="gg-trash"></i> Borrar</button>
                    <button id="submit-drawing-btn" class="btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-5 rounded-lg text-xl">¬°Listo!</button>
                </div>
            </div>
            <div id="waiting-for-drawings" class="hidden text-center py-24">
                <h2 class="text-3xl font-bold text-gray-600">¬°Dibujo enviado!</h2>
                <p class="text-2xl text-gray-500 mt-2">Esperando a los dem√°s jugadores...</p>
            </div>
        </div>
    </div>

    <div id="round-results-screen" class="screen w-full max-w-3xl mx-auto flex-col items-center text-center">
        <div class="card w-full">
            <h2 id="result-title" class="text-5xl font-bold mb-4 handwriting">¬°Tiempo!</h2>
            <div id="answer-reveal" class="text-2xl mb-6">La respuesta correcta era: <strong id="correct-answer-text" class="text-green-600 font-bold"></strong></div>
            <div id="vote-reveal" class="w-full text-left text-xl hidden mb-6 bg-gray-100 p-4 rounded-lg">
                <h4 class="font-bold text-center mb-2">As√≠ hab√©is votado:</h4>
                <ul id="vote-details-list"></ul>
            </div>
             <div id="drawing-results-reveal" class="w-full hidden mb-6 p-4 rounded-lg">
                <h3 class="text-3xl font-semibold mb-4 handwriting">Repaso de los Dibujos</h3>
                <div id="drawing-results-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
             </div>
            <div class="w-full bg-gray-50 p-4 rounded-lg">
                <h3 class="text-3xl font-semibold mb-4 handwriting">Resultados de la Ronda</h3>
                <div id="round-player-results" class="space-y-3"></div>
            </div>
            <button id="next-question-btn" class="btn w-full max-w-xs bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg text-2xl mt-8 hidden">¬°Listo!</button>
            <button id="show-final-results-btn" class="btn w-full max-w-xs bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-4 rounded-lg text-2xl mt-8 hidden">Ver Resultados Finales</button>
        </div>
    </div>

    <div id="game-over-screen" class="screen w-full max-w-3xl mx-auto flex-col items-center text-center">
        <div class="card w-full">
            <h2 class="text-6xl font-bold mb-4 handwriting">¬°Fin del Juego!</h2>
            <div id="winner-announcement" class="text-4xl mb-8"></div>
            <div class="w-full bg-gray-50 p-6 rounded-lg">
                <h3 class="text-4xl font-semibold mb-4 handwriting">Puntuaci√≥n Final</h3>
                <div id="final-scores" class="space-y-3"></div>
            </div>
            <button id="play-again-btn" class="btn w-full max-w-xs bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-2xl mt-8">Jugar Otra Vez</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, onValue, set, update, get, serverTimestamp, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://webmc-46fab-default-rtdb.europe-west1.firebasedatabase.app/" };
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        let localPlayerId = sessionStorage.getItem('quizPlayerId') || `player_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
        sessionStorage.setItem('quizPlayerId', localPlayerId);
        
        let currentGameId = null, gameRef = null, gameData = null;
        let timerInterval = null, isMovingToNext = false;
        let isDrawing = false, canvas, ctx, lastPos;

        const screens = { lobby: document.getElementById('lobby-screen'), interstitial: document.getElementById('interstitial-screen'), quiz: document.getElementById('quiz-screen'), drawing: document.getElementById('drawing-screen'), roundResults: document.getElementById('round-results-screen'), gameOver: document.getElementById('game-over-screen') };
        const playerNameInput = document.getElementById('player-name-input');
        const createGameBtn = document.getElementById('create-game-btn');
        const joinGameBtn = document.getElementById('join-game-btn');
        const gameIdInput = document.getElementById('game-id-input');
        const confirmJoinBtn = document.getElementById('confirm-join-btn');
        const initialOptions = document.getElementById('initial-options');
        const createMenu = document.getElementById('create-menu');
        const showCreateMenuBtn = document.getElementById('show-create-menu-btn');
        const backFromCreateBtn = document.getElementById('back-from-create-btn');
        const joinOptions = document.getElementById('join-options');
        const waitingRoom = document.getElementById('waiting-room');
        const gameIdDisplay = document.getElementById('game-id-display');
        const playerList = document.getElementById('player-list');
        const startGameBtn = document.getElementById('start-game-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const showFinalResultsBtn = document.getElementById('show-final-results-btn');
        const playAgainBtn = document.getElementById('play-again-btn');
        const backToLobbyBtn = document.getElementById('back-to-lobby-btn');
        const toastEl = document.getElementById('toast');
        const voteRevealEl = document.getElementById('vote-reveal');
        const answerRevealEl = document.getElementById('answer-reveal');
        const drawingResultsRevealEl = document.getElementById('drawing-results-reveal');

        const fetchQuestions = async (modes) => {
            const allVotingQuestions = [
                { "type": "voting", "question": "¬øQui√©n durar√≠a m√°s en una isla desierta?", "topic": "Votacion" },
                { "type": "voting", "question": "¬øQui√©n tiene m√°s probabilidades de convertirse en millonario?", "topic": "Votacion" },
                { "type": "voting", "question": "¬øQui√©n es el m√°s propenso a tropezar con su propia sombra?", "topic": "Votacion" },
                { "type": "voting", "question": "¬øQui√©n dar√≠a el discurso m√°s raro en una boda?", "topic": "Votacion" },
                { "type": "voting", "question": "Si formaran una banda, ¬øqui√©n ser√≠a el cantante principal?", "topic": "Votacion" },
                { "type": "voting", "question": "¬øQui√©n sobrevivir√≠a a un apocalipsis zombie?", "topic": "Votacion" },
                { "type": "voting", "question": "¬øQui√©n es m√°s probable que se r√≠a en un momento serio?", "topic": "Votacion" },
                { "type": "voting", "question": "¬øQui√©n es el mejor para guardar un secreto?", "topic": "Votacion" },
                { "type": "voting", "question": "¬øQui√©n tiene el sentido del humor m√°s extra√±o?", "topic": "Votacion" },
                { "type": "voting", "question": "¬øQui√©n se perder√≠a con un mapa en la mano?", "topic": "Votacion" },
                { "type": "voting", "question": "¬øQui√©n es m√°s probable que hable con los animales?", "topic": "Votacion" },
                { "type": "voting", "question": "¬øQui√©n ganar√≠a un concurso de comer perritos calientes?", "topic": "Votacion" },
                { "type": "voting", "question": "¬øQui√©n es m√°s probable que se una a un circo?", "topic": "Votacion" },
                { "type": "voting", "question": "¬øQui√©n es el m√°s dram√°tico del grupo?", "topic": "Votacion" },
                { "type": "voting", "question": "¬øQui√©n ordenar√≠a pizza de pi√±a sin remordimientos?", "topic": "Votacion" }
            ];

            const url = 'https://raw.githubusercontent.com/Logise1123/familyquiz/main/questions.json';
            let triviaQuestions = [];
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                triviaQuestions = await response.json();
            } catch (error) {
                console.error("No se pudieron cargar las preguntas de trivia:", error);
                showAlert("Error al cargar preguntas de trivia.");
                if(modes.quiz) return [];
            }
            
            let finalQuestions = [];
            const selectedCount = Object.values(modes).filter(Boolean).length;

            if (selectedCount === 3) {
                finalQuestions = triviaQuestions.sort(() => 0.5 - Math.random()).slice(0, 10)
                    .concat(allVotingQuestions.sort(() => 0.5 - Math.random()).slice(0, 5))
                    .concat(Array(5).fill({ "type": "drawing", "topic": "Dibujo" }));
            } else if (selectedCount === 2) {
                if (modes.quiz && modes.voting) {
                    finalQuestions = triviaQuestions.sort(() => 0.5 - Math.random()).slice(0, 10)
                        .concat(allVotingQuestions.sort(() => 0.5 - Math.random()).slice(0, 10));
                } else if (modes.quiz && modes.drawing) {
                    finalQuestions = triviaQuestions.sort(() => 0.5 - Math.random()).slice(0, 10)
                        .concat(Array(10).fill({ "type": "drawing", "topic": "Dibujo" }));
                } else if (modes.voting && modes.drawing) {
                    finalQuestions = allVotingQuestions.sort(() => 0.5 - Math.random()).slice(0, 10)
                        .concat(Array(10).fill({ "type": "drawing", "topic": "Dibujo" }));
                }
            } else if (selectedCount === 1) {
                if (modes.quiz) {
                    finalQuestions = triviaQuestions.sort(() => 0.5 - Math.random()).slice(0, 20);
                } else if (modes.voting) {
                    finalQuestions = allVotingQuestions.sort(() => 0.5 - Math.random()).slice(0, 20);
                } else if (modes.drawing) {
                    finalQuestions = Array(20).fill({ "type": "drawing", "topic": "Dibujo" });
                }
            }
            
            return finalQuestions.sort(() => 0.5 - Math.random());
        };

        const drawingWords = ["Casa", "Sol", "Coche", "√Årbol", "Perro", "Gato", "Flor", "Barco", "Avi√≥n", "Pelota", "Coraz√≥n", "Estrella", "Luna", "Monta√±a", "R√≠o", "Puente", "Libro", "Silla", "Mesa", "Tel√©fono", "Guitarra", "Reloj", "Llave", "Gafas", "Manzana", "Pl√°tano", "Pizza", "Hamburguesa", "Helado", "Sombrero"];

        const showAlert = (message) => {
            toastEl.innerText = message;
            toastEl.classList.add('show');
            setTimeout(() => { toastEl.classList.remove('show'); }, 3000);
        };

        const switchScreen = (screenName) => {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            if (screens[screenName]) screens[screenName].classList.add('active');
        };

        const createGame = async () => {
            if (!playerNameInput.value.trim()) { showAlert("Por favor, introduce tu nombre."); return; }
            
            const selectedModes = {
                quiz: document.getElementById('mode-quiz').checked,
                voting: document.getElementById('mode-voting').checked,
                drawing: document.getElementById('mode-drawing').checked,
            };

            if (Object.values(selectedModes).filter(Boolean).length === 0) {
                showAlert("Debes seleccionar al menos un tipo de pregunta.");
                return;
            }

            createGameBtn.disabled = true;
            try {
                const gameQuestions = await fetchQuestions(selectedModes);
                if (!gameQuestions || gameQuestions.length === 0) {
                    showAlert("No se pudieron generar preguntas para los modos seleccionados.");
                    throw new Error("Question generation failed");
                }
                currentGameId = Math.random().toString(36).substr(2, 5).toUpperCase();
                gameRef = ref(database, `games/${currentGameId}`);
                await set(gameRef, {
                    hostId: localPlayerId, gameState: 'lobby', currentQuestionIndex: -1, questions: gameQuestions,
                    players: { [localPlayerId]: { name: playerNameInput.value.trim(), score: 0 } }
                });
                onDisconnect(ref(database, `games/${currentGameId}/players/${localPlayerId}`)).remove();
                subscribeToGameChanges();
            } catch (error) {
                console.error("Error al crear la partida:", error);
                createGameBtn.disabled = false;
            }
        };

        const joinGame = async () => {
            if (!playerNameInput.value.trim()) { showAlert("Por favor, introduce tu nombre."); return; }
            const gameIdToJoin = gameIdInput.value.trim().toUpperCase();
            if (!gameIdToJoin) { showAlert("Por favor, introduce un c√≥digo de partida."); return; }
            confirmJoinBtn.disabled = true;
            try {
                const joinRef = ref(database, `games/${gameIdToJoin}`);
                const snapshot = await get(joinRef);
                if (!snapshot.exists() || snapshot.val().gameState !== 'lobby') {
                    showAlert("Partida no encontrada o ya comenzada.");
                    throw new Error("Game not found or started");
                }
                currentGameId = gameIdToJoin;
                gameRef = joinRef;
                const playerRef = ref(database, `games/${currentGameId}/players/${localPlayerId}`);
                await set(playerRef, { name: playerNameInput.value.trim(), score: 0 });
                onDisconnect(playerRef).remove();
                subscribeToGameChanges();
            } catch (error) {
                console.error("Error al unirse:", error);
                confirmJoinBtn.disabled = false;
            }
        };
        
        const subscribeToGameChanges = () => {
            if (!gameRef) return;
            onValue(gameRef, (snapshot) => {
                gameData = snapshot.val();
                if (gameData) {
                    // Host-only logic for automatic state transitions
                    if (gameData.hostId === localPlayerId) {
                        // Check if all players have submitted their drawing to move to guessing
                        if (gameData.gameState === 'drawing' && gameData.players && Object.values(gameData.players).every(p => p.drawingData)) {
                            update(gameRef, { gameState: 'guessing' });
                            // Return early to prevent rendering the old state while the new one is propagating
                            return;
                        }
                    }
                    renderGame();
                } else {
                    showAlert("La partida ha terminado.");
                    resetGame();
                }
            });
        };

        const renderGame = () => {
            if (!gameData || !gameData.players) return;
            if (!gameData.players[localPlayerId] && gameData.gameState !== 'lobby') {
                showAlert("Has sido desconectado."); resetGame(); return;
            }
            switch (gameData.gameState) {
                case 'lobby': renderLobby(); break;
                case 'interstitial': renderInterstitial(); break;
                case 'drawing': renderDrawingScreen(); break;
                case 'guessing': renderGuessingScreen(); break;
                case 'question': renderQuestionScreen(); break;
                case 'roundResult': renderRoundResult(); break;
                case 'gameOver': renderGameOver(); break;
            }
        };
        
        const renderLobby = () => {
            switchScreen('lobby');
            
            if (currentGameId) {
                initialOptions.classList.add('hidden'); 
                createMenu.classList.add('hidden');
                joinOptions.classList.add('hidden');
                waitingRoom.classList.remove('hidden');
            } else {
                initialOptions.classList.remove('hidden'); 
                createMenu.classList.add('hidden');
                joinOptions.classList.add('hidden');
                waitingRoom.classList.add('hidden');
            }

            gameIdDisplay.innerHTML = `${currentGameId || '...'} <i class="gg-copy text-gray-500"></i>`;
            if(gameData.players) {
              playerList.innerHTML = Object.entries(gameData.players).map(([id, p]) => `<li class="p-1 flex items-center gap-2"><span class="text-2xl">${gameData.hostId === id ? 'üëë' : 'üë§'}</span> ${p.name}</li>`).join('');
            }
            if (gameData.hostId === localPlayerId) startGameBtn.classList.remove('hidden');
        };

        const renderInterstitial = () => {
            switchScreen('interstitial');
            const question = gameData.questions[gameData.currentQuestionIndex];
            if (!question) return;
            document.getElementById('interstitial-difficulty').innerText = question.difficulty || '';
            const topicEl = document.getElementById('interstitial-topic');
            topicEl.innerText = question.topic;
            topicEl.className = 'text-8xl font-bold mt-4 break-words handwriting'; 
            topicEl.classList.add('topic-' + question.topic.toLowerCase().replace(/\s+/g, '-'));
            if (gameData.hostId === localPlayerId) {
                setTimeout(() => {
                    const nextState = question.type === 'drawing' ? 'drawing' : 'question';
                    const updates = { gameState: nextState };
                    if(question.type === 'drawing') {
                        const shuffledWords = drawingWords.sort(() => 0.5 - Math.random());
                        const playerIds = Object.keys(gameData.players);
                        updates.playerOrder = playerIds.sort(() => 0.5 - Math.random());
                        updates.guessingIndex = 0;
                        playerIds.forEach((id, i) => {
                            updates[`players/${id}/secretWord`] = shuffledWords[i % shuffledWords.length];
                            const decoys = shuffledWords.filter(w => w !== shuffledWords[i % shuffledWords.length]).sort(() => 0.5 - Math.random()).slice(0, 3);
                            updates[`players/${id}/decoys`] = decoys;
                        });
                    } else {
                        updates.questionStartTime = serverTimestamp();
                    }
                    update(gameRef, updates);
                }, 4000); 
            }
        };
        
        const renderDrawingScreen = () => {
            switchScreen('drawing');
            document.getElementById('word-to-draw').innerText = gameData.players[localPlayerId].secretWord;
            
            document.getElementById('drawing-ui').classList.remove('hidden');
            document.getElementById('waiting-for-drawings').classList.add('hidden');
            document.getElementById('drawing-screen').querySelectorAll('button').forEach(b => b.disabled = false);

            setupCanvas();
            
            clearInterval(timerInterval);
            const timerBar = document.getElementById('drawing-timer-bar'), timerDisplay = document.getElementById('drawing-timer');
            let timeLeft = 30;
            timerBar.style.width = '100%';
            timerDisplay.innerText = 30;
            timerInterval = setInterval(() => {
                timeLeft--;
                timerBar.style.width = `${(timeLeft / 30) * 100}%`;
                timerDisplay.innerText = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitDrawing();
                }
            }, 1000);
        };

        const renderQuestionScreen = () => {
            switchScreen('quiz');
            document.getElementById('drawing-display-img').classList.add('hidden');
            document.getElementById('quiz-header-text').innerHTML = `Pregunta <span id="question-number">${gameData.currentQuestionIndex + 1}</span>/<span id="question-total">${gameData.questions.length}</span>`;
            
            clearInterval(timerInterval);
            document.getElementById('waiting-for-players').classList.add('hidden');
            const question = gameData.questions[gameData.currentQuestionIndex];
            document.getElementById('question-text').innerText = question.question;
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';

            const options = question.type === 'voting'
                ? Object.entries(gameData.players)
                : question.options.map(opt => [opt, opt]);

            options.forEach(([id, data]) => {
                const button = document.createElement('button');
                button.className = "option-btn btn w-full text-gray-800 font-semibold py-3 px-4 rounded-lg text-xl md:text-2xl";
                button.innerText = question.type === 'voting' ? data.name : data;
                button.onclick = () => question.type === 'voting' ? selectVote(id) : selectAnswer(id);
                optionsContainer.appendChild(button);
            });

            const myAnswer = gameData.players[localPlayerId]?.currentAnswer || gameData.players[localPlayerId]?.currentVote;
             if (myAnswer) {
                 document.querySelectorAll('.option-btn').forEach(btn => {
                     btn.disabled = true;
                     const expectedText = question.type === 'voting' ? gameData.players[myAnswer]?.name : myAnswer;
                     if(btn.innerText === expectedText) btn.classList.add('selected');
                 });
                 document.getElementById('waiting-for-players').classList.remove('hidden');
            }

            const startTime = gameData.questionStartTime;
            const timerBar = document.getElementById('timer-bar'), timerDisplay = document.getElementById('timer');
            timerInterval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;
                const remaining = Math.max(0, 20 - elapsed);
                timerBar.style.width = `${(remaining / 20) * 100}%`;
                timerDisplay.innerText = Math.ceil(remaining);
                const allAnswered = Object.values(gameData.players).every(p => p.currentAnswer || p.currentVote);
                if ((remaining <= 0 || allAnswered) && gameData.hostId === localPlayerId) {
                    clearInterval(timerInterval); showRoundResults();
                }
            }, 100);
        };

        const renderGuessingScreen = () => {
            switchScreen('quiz');
            document.getElementById('waiting-for-players').classList.add('hidden');
            const guessingIndex = gameData.guessingIndex;
            const drawerId = gameData.playerOrder[guessingIndex];
            const drawer = gameData.players[drawerId];
            
            document.getElementById('quiz-header-text').innerText = `Dibujo ${guessingIndex + 1}/${gameData.playerOrder.length}`;
            document.getElementById('question-text').innerText = `¬øQu√© ha dibujado ${drawer.name}?`;
            
            const img = document.getElementById('drawing-display-img');
            img.src = drawer.drawingData || 'https://placehold.co/500x300/eee/ccc?text=No+ha+dibujado+nada';
            img.classList.remove('hidden');
            
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';

            if (drawerId === localPlayerId) {
                optionsContainer.innerHTML = '<p class="text-center text-2xl col-span-2">¬°Est√°n adivinando tu obra de arte!</p>';
            } else {
                 const options = [drawer.secretWord, ...drawer.decoys].sort(() => 0.5 - Math.random());
                 options.forEach(word => {
                     const button = document.createElement('button');
                     button.className = "option-btn btn w-full text-gray-800 font-semibold py-3 px-4 rounded-lg text-xl md:text-2xl";
                     button.innerText = word;
                     button.onclick = () => selectGuess(drawerId, word);
                     optionsContainer.appendChild(button);
                 });
                 const myGuess = gameData.players[localPlayerId].guesses?.[drawerId];
                 if(myGuess) {
                      document.querySelectorAll('.option-btn').forEach(btn => {
                           btn.disabled = true;
                           if(btn.innerText === myGuess) btn.classList.add('selected');
                     });
                     document.getElementById('waiting-for-players').classList.remove('hidden');
                 }
            }

            if(gameData.hostId === localPlayerId) {
                const nonDrawers = Object.keys(gameData.players).filter(id => id !== drawerId);
                const allGuessed = nonDrawers.every(id => gameData.players[id].guesses?.[drawerId]);
                if(allGuessed) {
                    const nextGuessingIndex = guessingIndex + 1;
                    if (nextGuessingIndex >= gameData.playerOrder.length) {
                        setTimeout(showRoundResults, 1000);
                    } else {
                        setTimeout(() => update(gameRef, { guessingIndex: nextGuessingIndex }), 1000);
                    }
                }
            }
        };

        const renderRoundResult = () => {
            switchScreen('roundResults');
            clearInterval(timerInterval);
            isMovingToNext = false;
            
            const question = gameData.questions[gameData.currentQuestionIndex];
            answerRevealEl.classList.add('hidden');
            voteRevealEl.classList.add('hidden');
            drawingResultsRevealEl.classList.add('hidden');

            if (question.type === 'drawing') {
                drawingResultsRevealEl.classList.remove('hidden');
                document.getElementById('result-title').innerText = "Resultados del Dibujo";
                const grid = document.getElementById('drawing-results-grid');
                grid.innerHTML = '';
                gameData.playerOrder.forEach(pId => {
                    const player = gameData.players[pId];
                    const correctGuesses = Object.values(gameData.players).filter(p => p.guesses?.[pId] === player.secretWord).length;
                    grid.innerHTML += `
                        <div class="p-2 bg-white rounded-lg shadow">
                            <img src="${player.drawingData}" class="w-full h-auto object-contain rounded-md bg-white border">
                            <p class="mt-2 font-bold text-center">${player.name}</p>
                            <p class="text-center text-sm text-indigo-600">"${player.secretWord}"</p>
                            <p class="text-center text-sm">${correctGuesses} acierto(s)</p>
                        </div>`;
                });

            } else if (question.type === 'voting') {
                voteRevealEl.classList.remove('hidden');
                document.getElementById('result-title').innerText = "Resultados de la Votaci√≥n";
                document.getElementById('vote-details-list').innerHTML = Object.values(gameData.players)
                    .map(p => p.currentVote ? `<li><strong>${p.name}</strong> vot√≥ por <strong>${gameData.players[p.currentVote]?.name || '?'}</strong></li>` : '')
                    .join('');
            } else {
                answerRevealEl.classList.remove('hidden');
                document.getElementById('result-title').innerText = "Resultados de la Ronda";
                document.getElementById('correct-answer-text').innerText = question.answer;
            }

            document.getElementById('round-player-results').innerHTML = Object.values(gameData.players)
                .sort((a,b) => b.score - a.score)
                .map(player => {
                    const answerIcon = player.currentAnswer ? (player.currentAnswer === question.answer ? '‚úÖ' : '‚ùå') : (question.type === 'voting' ? 'üó≥Ô∏è' : (question.type === 'drawing' ? 'üé®' : 'ü§î'));
                    const pointsGained = player.lastRoundPoints > 0 ? `+${player.lastRoundPoints}` : '';
                    const readyCheck = player.readyForNext ? '<i class="gg-check-o text-green-500"></i>' : '';
                    return `<div class="flex justify-between items-center bg-white p-3 rounded-lg fade-in text-xl">
                        <div class="flex items-center gap-3"><span class="w-6">${readyCheck}</span>${answerIcon} ${player.name}</div>
                        <div class="text-right"><span class="font-bold">${player.score} pts</span><span class="text-sm text-green-600 ml-2 font-bold">${pointsGained}</span></div>
                    </div>`;
                }).join('');
            
            const isLastQuestion = gameData.currentQuestionIndex >= gameData.questions.length - 1;
            const primaryBtn = isLastQuestion ? showFinalResultsBtn : nextQuestionBtn;
            primaryBtn.classList.remove('hidden');
            (isLastQuestion ? nextQuestionBtn : showFinalResultsBtn).classList.add('hidden');
            primaryBtn.disabled = !!gameData.players[localPlayerId]?.readyForNext;
            primaryBtn.innerText = gameData.players[localPlayerId]?.readyForNext ? "Esperando..." : (isLastQuestion ? "Ver Resultados Finales" : "¬°Listo!");

            if (gameData.hostId === localPlayerId && Object.values(gameData.players).every(p => p.readyForNext)) {
                isLastQuestion ? update(gameRef, { gameState: 'gameOver' }) : moveToNextQuestionWithDelay();
            }
        };

        const renderGameOver = () => {
            switchScreen('gameOver');
            const players = Object.values(gameData.players).sort((a, b) => b.score - a.score);
            document.getElementById('winner-announcement').innerHTML = `üèÜ ¬°El ganador es <strong class="text-amber-500">${players[0].name}</strong>! üèÜ`;
            document.getElementById('final-scores').innerHTML = players.map((player, index) => {
                const rankIcon = ['ü•á', 'ü•à', 'ü•â'][index] || `#${index+1}`;
                return `<div class="flex justify-between items-center bg-white p-3 rounded-lg fade-in text-xl">
                    <div>${rankIcon} ${player.name}</div><div class="font-bold">${player.score} pts</div>
                </div>`;
            }).join('');
        };
        
        const handleStartGame = () => update(gameRef, { gameState: 'interstitial', currentQuestionIndex: 0 });
        const selectAnswer = (answer) => update(gameRef, { [`players/${localPlayerId}/currentAnswer`]: answer, [`players/${localPlayerId}/answerTime`]: 20 - parseInt(document.getElementById('timer').innerText) });
        const selectVote = (votedPlayerId) => update(gameRef, { [`players/${localPlayerId}/currentVote`]: votedPlayerId });
        const selectGuess = (drawerId, word) => update(gameRef, { [`players/${localPlayerId}/guesses/${drawerId}`]: word });
        
        const showRoundResults = () => {
            if (gameData.gameState === 'roundResult' || gameData.hostId !== localPlayerId) return;
            const updates = { gameState: 'roundResult' };
            const question = gameData.questions[gameData.currentQuestionIndex];
            
            if (question.type === 'drawing') {
                const correctGuessCounts = {};
                gameData.playerOrder.forEach(pId => correctGuessCounts[pId] = 0);
                Object.values(gameData.players).forEach(player => {
                    if(player.guesses) {
                        Object.entries(player.guesses).forEach(([drawerId, guess]) => {
                            if (gameData.players[drawerId]?.secretWord === guess) {
                                correctGuessCounts[drawerId]++;
                            }
                        });
                    }
                });
                const maxGuesses = Math.max(0, ...Object.values(correctGuessCounts));
                gameData.playerOrder.forEach(pId => {
                    const points = (correctGuessCounts[pId] === maxGuesses && maxGuesses > 0) ? 100 : 0;
                    updates[`players/${pId}/lastRoundPoints`] = points;
                    if(points > 0) updates[`players/${pId}/score`] = gameData.players[pId].score + points;
                });

            } else if (question.type === 'voting') {
                const voteCounts = {};
                Object.keys(gameData.players).forEach(pId => voteCounts[pId] = 0);
                Object.values(gameData.players).forEach(p => { if (p.currentVote) voteCounts[p.currentVote]++; });
                const sortedVotes = Object.entries(voteCounts).sort(([,a],[,b]) => b-a);
                const winnerIds = (sortedVotes.length > 0 && sortedVotes[0][1] > 0) ? sortedVotes.filter(v => v[1] === sortedVotes[0][1]).map(v => v[0]) : [];
                Object.keys(gameData.players).forEach(pId => {
                    const points = (winnerIds.length > 0 && gameData.players[pId].currentVote && winnerIds.includes(gameData.players[pId].currentVote)) ? 100 : 0;
                    updates[`players/${pId}/lastRoundPoints`] = points;
                    if(points > 0) updates[`players/${pId}/score`] = gameData.players[pId].score + points;
                });
            } else {
                const correctAnswer = question.answer;
                Object.keys(gameData.players).forEach(playerId => {
                    const p = gameData.players[playerId];
                    const points = (p.currentAnswer === correctAnswer && p.answerTime) ? (50 + Math.ceil(p.answerTime * 2.5)) : 0;
                    updates[`players/${playerId}/lastRoundPoints`] = points;
                    if(points > 0) updates[`players/${playerId}/score`] = p.score + points;
                });
            }
             Object.keys(gameData.players).forEach(pId => {
                if(updates[`players/${pId}/lastRoundPoints`] === undefined) {
                    updates[`players/${pId}/lastRoundPoints`] = 0;
                }
                updates[`players/${pId}/readyForNext`] = false
            });
            update(gameRef, updates);
        };
        
        const handlePlayerReady = () => update(gameRef, { [`players/${localPlayerId}/readyForNext`]: true });
        
        const moveToNextQuestionWithDelay = () => {
            if (isMovingToNext) return;
            isMovingToNext = true;
            let countdown = 3;
            document.getElementById('result-title').innerText = `Siguiente en ${countdown}...`;
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) document.getElementById('result-title').innerText = `Siguiente en ${countdown}...`;
                else {
                    clearInterval(countdownInterval);
                    const updates = { gameState: 'interstitial', currentQuestionIndex: gameData.currentQuestionIndex + 1 };
                    Object.keys(gameData.players).forEach(pId => {
                        updates[`players/${pId}/currentAnswer`] = null;
                        updates[`players/${pId}/answerTime`] = null;
                        updates[`players/${pId}/currentVote`] = null;
                        updates[`players/${pId}/readyForNext`] = false;
                        updates[`players/${pId}/lastRoundPoints`] = 0;
                        updates[`players/${pId}/secretWord`] = null;
                        updates[`players/${pId}/decoys`] = null;
                        updates[`players/${pId}/drawingData`] = null;
                        updates[`players/${pId}/guesses`] = null;
                    });
                    update(gameRef, updates);
                }
            }, 1000);
        };
        
        const resetGame = () => {
            if (gameData && gameData.hostId === localPlayerId) remove(gameRef);
            sessionStorage.removeItem('quizPlayerId');
            window.location.reload();
        };

        const getPointerPos = (e) => {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }
        const startDrawing = (e) => { isDrawing = true; lastPos = getPointerPos(e); }
        const stopDrawing = () => { isDrawing = false; }
        const draw = (e) => {
            if (!isDrawing) return;
            e.preventDefault();
            const pos = getPointerPos(e);
            ctx.beginPath();
            ctx.moveTo(lastPos.x, lastPos.y);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            lastPos = pos;
        }

        const setupCanvas = () => {
            canvas = document.getElementById('drawing-canvas');
            ctx = canvas.getContext('2d');
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ['mousedown', 'touchstart'].forEach(evt => canvas.addEventListener(evt, startDrawing));
            ['mouseup', 'touchend', 'mouseleave'].forEach(evt => canvas.addEventListener(evt, stopDrawing));
            ['mousemove', 'touchmove'].forEach(evt => canvas.addEventListener(evt, draw));
        }

        const submitDrawing = () => {
            clearInterval(timerInterval);
            const dataUrl = canvas.toDataURL();
            document.getElementById('drawing-ui').classList.add('hidden');
            document.getElementById('waiting-for-drawings').classList.remove('hidden');
            update(gameRef, { [`players/${localPlayerId}/drawingData`]: dataUrl });
        }
        
        showCreateMenuBtn.addEventListener('click', () => {
            initialOptions.classList.add('hidden');
            createMenu.classList.remove('hidden');
        });
        
        backFromCreateBtn.addEventListener('click', () => {
            createMenu.classList.add('hidden');
            initialOptions.classList.remove('hidden');
        });

        createGameBtn.addEventListener('click', createGame);
        joinGameBtn.addEventListener('click', () => { 
            initialOptions.classList.add('hidden'); 
            joinOptions.classList.remove('hidden'); 
        });
        confirmJoinBtn.addEventListener('click', joinGame);
        backToLobbyBtn.addEventListener('click', () => { 
            joinOptions.classList.add('hidden'); 
            initialOptions.classList.remove('hidden'); 
        })
        startGameBtn.addEventListener('click', handleStartGame);
        nextQuestionBtn.addEventListener('click', handlePlayerReady);
        showFinalResultsBtn.addEventListener('click', handlePlayerReady);
        playAgainBtn.addEventListener('click', resetGame);
        gameIdDisplay.addEventListener('click', () => { if (navigator.clipboard) navigator.clipboard.writeText(currentGameId).then(() => showAlert('¬°C√≥digo copiado!')); });
        document.getElementById('clear-canvas-btn').addEventListener('click', () => ctx.clearRect(0, 0, canvas.width, canvas.height));
        document.getElementById('submit-drawing-btn').addEventListener('click', submitDrawing);

    </script>
</body>
</html>
